# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  PHPeek PM Configuration (Rootless)                                       ║
# ║  Process Manager for PHP Docker Containers - Unprivileged Port 8080       ║
# ║  https://github.com/phpeek/phpeek-pm                                    ║
# ╚═══════════════════════════════════════════════════════════════════════════╝

version: "1.0"

global:
  # Shutdown timeout for graceful process termination
  shutdown_timeout: 30

  # Logging configuration
  log_level: info
  log_format: json

  # Management API (disabled by default for security)
  api_enabled: false
  api_port: 9180

  # Prometheus Metrics (enabled by default, localhost only for security)
  metrics_enabled: true
  metrics_port: 9090
  metrics_path: /metrics

  # Restart configuration with exponential backoff
  restart_backoff_initial: 1s
  restart_backoff_max: 60s
  max_restart_attempts: 5

# ═══════════════════════════════════════════════════════════════════════════
# Process Definitions (DAG-based dependencies)
# ═══════════════════════════════════════════════════════════════════════════
processes:
  # ─────────────────────────────────────────────────────────────────────────
  # PHP-FPM - Core PHP process handler
  # ─────────────────────────────────────────────────────────────────────────
  php-fpm:
    enabled: true
    command: ["php-fpm", "-F", "-R"]
    type: longrun
    restart: always
    scale: 1
    stdout: true
    stderr: true
    health_check:
      type: tcp
      address: "127.0.0.1:9000"
      period: 5
      timeout: 3
      failure_threshold: 3

  # ─────────────────────────────────────────────────────────────────────────
  # Nginx - Web server (depends on PHP-FPM being ready)
  # ROOTLESS: Uses unprivileged port 8080 instead of 80
  # ─────────────────────────────────────────────────────────────────────────
  nginx:
    enabled: true
    command: ["nginx", "-g", "daemon off;"]
    type: longrun
    restart: always
    scale: 1
    depends_on:
      - php-fpm
    stdout: true
    stderr: true
    health_check:
      type: http
      url: "http://127.0.0.1:8080/health"
      period: 5
      timeout: 3
      failure_threshold: 3
      expected_status: 200

  # ─────────────────────────────────────────────────────────────────────────
  # Laravel Horizon - Queue Manager
  # Enable via PHPEEK_PM_PROCESS_HORIZON_ENABLED=true or LARAVEL_HORIZON=true
  # ─────────────────────────────────────────────────────────────────────────
  horizon:
    enabled: false
    command: ["php", "artisan", "horizon"]
    type: longrun
    restart: always
    scale: 1
    working_dir: /var/www/html
    stdout: true
    stderr: true
    shutdown:
      pre_stop_hook:
        command: ["php", "artisan", "horizon:terminate"]
        timeout: 60

  # ─────────────────────────────────────────────────────────────────────────
  # Laravel Reverb - WebSocket Server
  # Enable via PHPEEK_PM_PROCESS_REVERB_ENABLED=true or LARAVEL_REVERB=true
  # ─────────────────────────────────────────────────────────────────────────
  reverb:
    enabled: false
    command: ["php", "artisan", "reverb:start", "--host=0.0.0.0", "--port=8080"]
    type: longrun
    restart: always
    scale: 1
    working_dir: /var/www/html
    stdout: true
    stderr: true

  # ─────────────────────────────────────────────────────────────────────────
  # Queue Workers - Default Queue
  # Enable via PHPEEK_PM_PROCESS_QUEUE_DEFAULT_ENABLED=true or LARAVEL_QUEUE=true
  # ─────────────────────────────────────────────────────────────────────────
  queue-default:
    enabled: false
    command: ["php", "artisan", "queue:work", "redis", "--queue=default", "--tries=3"]
    type: longrun
    restart: always
    scale: 2
    working_dir: /var/www/html
    stdout: true
    stderr: true

  # ─────────────────────────────────────────────────────────────────────────
  # Queue Workers - High Priority Queue
  # Enable via PHPEEK_PM_PROCESS_QUEUE_HIGH_ENABLED=true or LARAVEL_QUEUE_HIGH=true
  # ─────────────────────────────────────────────────────────────────────────
  queue-high:
    enabled: false
    command: ["php", "artisan", "queue:work", "redis", "--queue=high", "--tries=3"]
    type: longrun
    restart: always
    scale: 1
    working_dir: /var/www/html
    stdout: true
    stderr: true

  # ─────────────────────────────────────────────────────────────────────────
  # Laravel Scheduler
  # Enable via PHPEEK_PM_PROCESS_SCHEDULER_ENABLED=true or LARAVEL_SCHEDULER=true
  # ─────────────────────────────────────────────────────────────────────────
  scheduler:
    enabled: false
    command: ["php", "artisan", "schedule:work"]
    type: longrun
    restart: always
    scale: 1
    working_dir: /var/www/html
    stdout: true
    stderr: true
