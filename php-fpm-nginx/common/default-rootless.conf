# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  PHPeek Base Image - Nginx Configuration (Rootless)                       ║
# ║  Production-ready with security hardening - Unprivileged port 8080        ║
# ╚═══════════════════════════════════════════════════════════════════════════╝

# Rate limiting zones (must be outside server block)
# Uncomment in nginx.conf or include globally if needed:
# limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
# limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

server {
    # Rootless: Use unprivileged port 8080 (ports < 1024 require root)
    listen 8080;
    server_name _;
    root /var/www/html/public;
    index index.php index.html;

    # Client configuration
    client_max_body_size 100M;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Hide Nginx version
    server_tokens off;

    # ─────────────────────────────────────────────────────────────────────────
    # Security Headers (Modern Best Practices)
    # ─────────────────────────────────────────────────────────────────────────
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Modern Cross-Origin Isolation Headers
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;

    # Permissions Policy (replaces Feature-Policy)
    add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

    # ─────────────────────────────────────────────────────────────────────────
    # Open File Cache (reduces file descriptor lookups)
    # ─────────────────────────────────────────────────────────────────────────
    open_file_cache max=10000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # ─────────────────────────────────────────────────────────────────────────
    # Gzip Compression (3-5x smaller responses)
    # ─────────────────────────────────────────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/x-javascript
        image/svg+xml;

    # ─────────────────────────────────────────────────────────────────────────
    # Main Location
    # ─────────────────────────────────────────────────────────────────────────
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # PHP-FPM (with PATH_INFO support for Symfony/Laravel)
    # ─────────────────────────────────────────────────────────────────────────
    location ~ \.php$ {
        try_files $uri =404;

        # Split path info for framework routing (CRITICAL for Symfony)
        fastcgi_split_path_info ^(.+\.php)(/.+)$;

        # PHP-FPM connection
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;

        # PATH_INFO support (required for Symfony, some Laravel routes)
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

        # FastCGI buffering
        fastcgi_buffers 8 16k;
        fastcgi_buffer_size 32k;
        fastcgi_busy_buffers_size 64k;

        # FastCGI timeouts
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        # Hide PHP version
        fastcgi_hide_header X-Powered-By;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # Rate Limited Endpoints (uncomment if rate limit zones defined)
    # ─────────────────────────────────────────────────────────────────────────
    # location /login {
    #     limit_req zone=login burst=5 nodelay;
    #     try_files $uri $uri/ /index.php?$query_string;
    # }
    #
    # location /api {
    #     limit_req zone=api burst=50;
    #     try_files $uri $uri/ /index.php?$query_string;
    # }

    # ─────────────────────────────────────────────────────────────────────────
    # Health check (SECURITY: localhost only)
    # ─────────────────────────────────────────────────────────────────────────
    location /health {
        allow 127.0.0.1;
        allow ::1;
        deny all;
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # PHP-FPM status (localhost only)
    location ~ ^/(fpm-status|fpm-ping)$ {
        allow 127.0.0.1;
        allow ::1;
        deny all;
        access_log off;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # Static files with caching
    # ─────────────────────────────────────────────────────────────────────────
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;

        # Prevent execution of PHP in static locations
        location ~ \.php$ {
            deny all;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # SECURITY: Block sensitive files and directories
    # ─────────────────────────────────────────────────────────────────────────

    # Block hidden files (.env, .git, .htaccess, .svn, etc.)
    location ~ /\.(env|git|svn|htaccess|htpasswd|gitignore|gitattributes|dockerignore) {
        deny all;
        return 404;
    }

    # Block all other hidden files
    location ~ /\. {
        deny all;
        return 404;
    }

    # Block sensitive project files (in root or subdirectories)
    location ~* ^/(composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|Dockerfile|docker-compose\.ya?ml|Makefile|Vagrantfile|\.editorconfig|phpunit\.xml|phpstan\.neon|psalm\.xml)$ {
        deny all;
        return 404;
    }

    # Block sensitive directories
    location ~ ^/(vendor|node_modules|storage/logs|storage/debugbar|tests|\.github|\.vscode|\.idea)/ {
        deny all;
        return 404;
    }

    # Block PHP files in upload directories (prevent malicious uploads)
    location ~* /(?:uploads|files|media)/.*\.php$ {
        deny all;
        return 404;
    }

    # Block access to artisan (Laravel CLI)
    location = /artisan {
        deny all;
        return 404;
    }

    # Block database and backup files
    location ~* \.(sql|bak|old|backup|swp|db|sqlite)$ {
        deny all;
        return 404;
    }
}
