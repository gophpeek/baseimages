name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  framework-detection-tests:
    name: Framework Detection Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run unit tests
        run: |
          chmod +x tests/integration/framework-detection/test-runner.sh
          ./tests/integration/framework-detection/test-runner.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test images
        run: |
          docker build -t ghcr.io/phpeek/baseimages/php-fpm-nginx:8.3-alpine -f php-fpm-nginx/8.3/alpine/Dockerfile .
          docker build -t ghcr.io/phpeek/baseimages/php-fpm-nginx:8.3-bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .
          docker build -t ghcr.io/phpeek/baseimages/php-fpm-nginx:8.3-trixie -f php-fpm-nginx/8.3/debian/trixie/Dockerfile .

      - name: Run Docker integration tests
        run: |
          chmod +x tests/integration/framework-detection/docker-test.sh
          ./tests/integration/framework-detection/docker-test.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/integration/framework-detection/fixtures/

  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: framework-detection-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build benchmark images
        run: |
          docker build -t phpeek-alpine -f php-fpm-nginx/8.3/alpine/Dockerfile .
          docker build -t phpeek-bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .
          docker build -t phpeek-trixie -f php-fpm-nginx/8.3/debian/trixie/Dockerfile .

      - name: Run performance benchmarks
        run: |
          chmod +x tests/benchmarks/run-benchmarks.sh
          ./tests/benchmarks/run-benchmarks.sh

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: tests/benchmarks/results/

  security-scan:
    name: CVE Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images for scanning
        run: |
          # Build only the root stage (not rootless which requires base images that may not exist yet)
          docker build --target root -t phpeek-scan:alpine -f php-fpm-nginx/8.3/alpine/Dockerfile .
          docker build --target root -t phpeek-scan:bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t phpeek-scan:trixie -f php-fpm-nginx/8.3/debian/trixie/Dockerfile .

      - name: Run Trivy vulnerability scanner (Alpine)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'phpeek-scan:alpine'
          format: 'sarif'
          output: 'trivy-alpine-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner (Bookworm)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'phpeek-scan:bookworm'
          format: 'sarif'
          output: 'trivy-bookworm-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner (Trixie)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'phpeek-scan:trixie'
          format: 'sarif'
          output: 'trivy-trixie-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: '.'

      - name: Generate security report summary
        if: always()
        run: |
          echo "# Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Alpine" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy image --severity CRITICAL,HIGH --format table phpeek-scan:alpine >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Bookworm (Debian 12)" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy image --severity CRITICAL,HIGH --format table phpeek-scan:bookworm >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Trixie (Debian 13)" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy image --severity CRITICAL,HIGH --format table phpeek-scan:trixie >> $GITHUB_STEP_SUMMARY || true
