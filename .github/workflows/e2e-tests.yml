name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'php-base/**'
      - 'php-fpm/**'
      - 'php-fpm-nginx/**'
      - 'php-swoole/**'
      - 'php-openswoole/**'
      - 'frankenphp/**'
      - 'tests/e2e/**'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'php-base/**'
      - 'php-fpm/**'
      - 'php-fpm-nginx/**'
      - 'php-swoole/**'
      - 'php-openswoole/**'
      - 'frankenphp/**'
      - 'tests/e2e/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to test'
        required: false
        default: '8.3'
        type: choice
        options:
          - '8.2'
          - '8.3'
          - '8.4'
          - 'all'
      os_variant:
        description: 'OS variant to test'
        required: false
        default: 'alpine'
        type: choice
        options:
          - 'alpine'
          - 'bookworm'
          - 'trixie'
          - 'all'
      scenario:
        description: 'Test scenario to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'plain-php'
          - 'laravel'
          - 'wordpress'
          - 'health-checks'
          - 'image-formats'
          - 'browsershot'
          - 'dusk-capabilities'
          - 'pest'
          - 'database'
          - 'security'
          - 'env-config'
          - 'phpeek-pm'
          - 'rootless'

env:
  REGISTRY: ghcr.io/phpeek/baseimages

jobs:
  # Quick smoke test on every push
  smoke-test:
    if: github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          docker build \
            -f php-fpm-nginx/8.3/alpine/Dockerfile \
            -t test-image:local \
            .

      - name: Run plain PHP E2E test
        env:
          IMAGE: test-image:local
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" plain-php

      - name: Run health check E2E test
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" health-checks

      - name: Run image formats test (GD, ImageMagick, AVIF, HEIF, WebP, PDF)
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" image-formats

  # Advanced tests - run on main branch pushes (separate job for browser-dependent tests)
  advanced-tests:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          docker build \
            -f php-fpm-nginx/8.3/alpine/Dockerfile \
            -t test-image:local \
            .

      - name: Run Browsershot test (Node.js, npm, Chromium, PDF)
        env:
          IMAGE: test-image:local
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" browsershot

      - name: Run Dusk capabilities test (browser automation)
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" dusk-capabilities

      - name: Run Pest v4 test
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" pest

      - name: Run security test
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" security

      - name: Run environment config test
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" env-config

      - name: Run PHPeek PM test
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" phpeek-pm

  # ─────────────────────────────────────────────────────────────────────────────
  # Rootless Container Tests
  # ─────────────────────────────────────────────────────────────────────────────
  rootless-test:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        php_version: ['8.3', '8.4']
        os_variant: ['alpine']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download PHPeek PM binaries
        run: |
          mkdir -p phpeek-pm/binaries
          PHPEEK_PM_VERSION="1.2.0"
          echo "Downloading PHPeek PM v${PHPEEK_PM_VERSION}..."
          curl -sL "https://github.com/gophpeek/phpeek-pm/releases/download/v${PHPEEK_PM_VERSION}/phpeek-pm-linux-amd64" \
            -o phpeek-pm/binaries/phpeek-pm-linux-amd64
          curl -sL "https://github.com/gophpeek/phpeek-pm/releases/download/v${PHPEEK_PM_VERSION}/phpeek-pm-linux-arm64" \
            -o phpeek-pm/binaries/phpeek-pm-linux-arm64
          chmod +x phpeek-pm/binaries/*
          ls -la phpeek-pm/binaries/

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          case "${{ matrix.os_variant }}" in
            alpine)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/alpine/Dockerfile" >> $GITHUB_OUTPUT
              ;;
            bookworm)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/debian/bookworm/Dockerfile" >> $GITHUB_OUTPUT
              ;;
            trixie)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/debian/trixie/Dockerfile" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build dependency images (php-base and php-fpm rootless)
        run: |
          # Build php-base rootless first
          case "${{ matrix.os_variant }}" in
            alpine)
              docker build --target rootless \
                -f php-base/${{ matrix.php_version }}/alpine/Dockerfile \
                -t ghcr.io/phpeek/baseimages/php-base:${{ matrix.php_version }}-alpine-rootless .
              docker build --target rootless \
                -f php-fpm/${{ matrix.php_version }}/alpine/Dockerfile \
                -t ghcr.io/phpeek/baseimages/php-fpm:${{ matrix.php_version }}-alpine-rootless .
              ;;
            bookworm)
              docker build --target rootless \
                -f php-base/${{ matrix.php_version }}/debian/bookworm/Dockerfile \
                -t ghcr.io/phpeek/baseimages/php-base:${{ matrix.php_version }}-bookworm-rootless .
              docker build --target rootless \
                -f php-fpm/${{ matrix.php_version }}/debian/bookworm/Dockerfile \
                -t ghcr.io/phpeek/baseimages/php-fpm:${{ matrix.php_version }}-bookworm-rootless .
              ;;
            trixie)
              docker build --target rootless \
                -f php-base/${{ matrix.php_version }}/debian/trixie/Dockerfile \
                -t ghcr.io/phpeek/baseimages/php-base:${{ matrix.php_version }}-trixie-rootless .
              docker build --target rootless \
                -f php-fpm/${{ matrix.php_version }}/debian/trixie/Dockerfile \
                -t ghcr.io/phpeek/baseimages/php-fpm:${{ matrix.php_version }}-trixie-rootless .
              ;;
          esac

      - name: Build rootless test image
        run: |
          docker build \
            --target rootless \
            -f ${{ steps.dockerfile.outputs.path }} \
            -t test-rootless:${{ matrix.php_version }}-${{ matrix.os_variant }} \
            .

      - name: Run rootless E2E test
        env:
          IMAGE: test-rootless:${{ matrix.php_version }}-${{ matrix.os_variant }}
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" rootless

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rootless-test-logs-${{ matrix.php_version }}-${{ matrix.os_variant }}
          path: /tmp/e2e-*.log
          retention-days: 7

  # Full matrix test (manual trigger or scheduled)
  full-matrix:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        php_version: ${{ github.event.inputs.php_version == 'all' && fromJson('["8.2", "8.3", "8.4"]') || fromJson(format('["{0}"]', github.event.inputs.php_version)) }}
        os_variant: ${{ github.event.inputs.os_variant == 'all' && fromJson('["alpine", "bookworm", "trixie"]') || fromJson(format('["{0}"]', github.event.inputs.os_variant)) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          # Map os_variant to Dockerfile path
          case "${{ matrix.os_variant }}" in
            alpine)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/alpine/Dockerfile" >> $GITHUB_OUTPUT
              ;;
            bookworm)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/debian/bookworm/Dockerfile" >> $GITHUB_OUTPUT
              ;;
            trixie)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/debian/trixie/Dockerfile" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build test image
        run: |
          docker build \
            -f ${{ steps.dockerfile.outputs.path }} \
            -t test-image:${{ matrix.php_version }}-${{ matrix.os_variant }} \
            .

      - name: Run E2E tests
        env:
          IMAGE: test-image:${{ matrix.php_version }}-${{ matrix.os_variant }}
          SCENARIO: ${{ github.event.inputs.scenario }}
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" "$SCENARIO"

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ matrix.php_version }}-${{ matrix.os_variant }}
          path: /tmp/e2e-*.log
          retention-days: 7

  # Comprehensive test on main branch pushes
  comprehensive:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          # Test one version per OS for comprehensive coverage
          - php_version: '8.3'
            os_variant: 'alpine'
            scenario: 'all'
          - php_version: '8.3'
            os_variant: 'bookworm'
            scenario: 'plain-php'
          - php_version: '8.3'
            os_variant: 'trixie'
            scenario: 'plain-php'
          # Also test latest PHP on Alpine
          - php_version: '8.4'
            os_variant: 'alpine'
            scenario: 'all'
          # Test latest PHP on Trixie (newest Debian)
          - php_version: '8.4'
            os_variant: 'trixie'
            scenario: 'plain-php'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          # Map os_variant to Dockerfile path
          case "${{ matrix.os_variant }}" in
            alpine)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/alpine/Dockerfile" >> $GITHUB_OUTPUT
              ;;
            bookworm)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/debian/bookworm/Dockerfile" >> $GITHUB_OUTPUT
              ;;
            trixie)
              echo "path=./php-fpm-nginx/${{ matrix.php_version }}/debian/trixie/Dockerfile" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build test image
        run: |
          docker build \
            -f ${{ steps.dockerfile.outputs.path }} \
            -t test-image:${{ matrix.php_version }}-${{ matrix.os_variant }} \
            .

      - name: Run E2E tests
        env:
          IMAGE: test-image:${{ matrix.php_version }}-${{ matrix.os_variant }}
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" "${{ matrix.scenario }}"

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ matrix.php_version }}-${{ matrix.os_variant }}
          path: /tmp/e2e-*.log
          retention-days: 7

  # Summary job
  summary:
    if: always()
    needs: [smoke-test, advanced-tests, comprehensive, rootless-test]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.smoke-test.result }}" == "failure" ] || \
             [ "${{ needs.advanced-tests.result }}" == "failure" ] || \
             [ "${{ needs.comprehensive.result }}" == "failure" ] || \
             [ "${{ needs.rootless-test.result }}" == "failure" ]; then
            echo "::error::E2E tests failed"
            exit 1
          fi
          echo "All E2E tests passed!"
