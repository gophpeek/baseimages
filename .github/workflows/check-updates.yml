name: Check Dependency Updates

on:
  schedule:
    # Every Monday at 00:00 UTC (before weekly security rebuilds at 01:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Run version update script
        id: update
        run: |
          chmod +x scripts/update-versions.sh

          # Capture output for PR body
          ./scripts/update-versions.sh 2>&1 | tee update-output.txt || true

          # Apply updates
          ./scripts/update-versions.sh --apply 2>&1 || true

          # Check if versions.json changed
          if git diff --quiet versions.json; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Extract update list for PR body
            grep -E "^\[UPDATE\]|^  -" update-output.txt > updates-summary.txt || true
          fi

      - name: Check PHP EOL warnings
        if: steps.update.outputs.has_updates == 'true'
        run: |
          TODAY=$(date +%Y-%m-%d)

          for version in $(jq -r '.php.supported[]' versions.json); do
            EOL=$(jq -r ".php.eol.\"$version\"" versions.json)
            TODAY_SEC=$(date -d "$TODAY" +%s)
            EOL_SEC=$(date -d "$EOL" +%s)
            DAYS_LEFT=$(( (EOL_SEC - TODAY_SEC) / 86400 ))

            if [ "$DAYS_LEFT" -lt 90 ]; then
              echo "::warning::PHP $version EOL in $DAYS_LEFT days ($EOL)"
            fi
          done

      - name: Check for new PHP minor version
        run: |
          for version in 8.5 9.0; do
            if curl -sf "https://www.php.net/releases/index.php?json&version=$version" > /dev/null 2>&1; then
              PHP_NEW=$(curl -s "https://www.php.net/releases/index.php?json&version=$version" | jq -r '.version // empty')
              if [ -n "$PHP_NEW" ] && ! jq -e ".php.supported | index(\"$version\")" versions.json > /dev/null; then
                echo "::warning::NEW PHP $version released: $PHP_NEW - Consider adding support!"
              fi
            fi
          done

      - name: Create Pull Request
        if: steps.update.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update versions.json with latest releases"
          title: "chore(deps): Weekly dependency updates"
          body: |
            ## Automated Version Updates

            This PR was automatically created by the weekly version check workflow.

            ### Updates Applied

            ```
            ${{ steps.update.outputs.updates || 'See workflow logs for details' }}
            ```

            ### Sources Checked

            - **PHP Extensions**: PECL (stable releases only)
            - **Swoole/OpenSwoole**: GitHub releases
            - **FrankenPHP**: GitHub releases
            - **PHPeek PM**: GitHub releases
            - **PHP Versions**: php.net official releases
            - **Node.js**: nodejs.org LTS releases

            ### Review Checklist

            - [ ] Check for breaking changes in major version updates
            - [ ] Verify extension compatibility with PHP versions
            - [ ] Review release notes for security updates
            - [ ] CI tests pass

            ---

            *Generated by [check-updates.yml](.github/workflows/check-updates.yml) using [update-versions.sh](scripts/update-versions.sh)*
          branch: deps/version-updates
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Summary
        run: |
          echo "## Dependency Check Summary" >> $GITHUB_STEP_SUMMARY

          if [ -f update-output.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat update-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No updates found" >> $GITHUB_STEP_SUMMARY
          fi
